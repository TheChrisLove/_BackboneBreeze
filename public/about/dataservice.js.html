<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: lib/dataservice.js</title>
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="keyword" content="" />
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    <meta property="og:site_name" content=""/>
    <meta property="og:url" content=""/>
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"ESS.App","disqus":"","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"","description":"","keyword":""}};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">ESS.App</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="App">
            <span class="title">
                <a href="App.html">App</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="BaseView">
            <span class="title">
                <a href="BaseView.html">BaseView</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="BaseView#_applyModelListeners"><a href="BaseView.html#_applyModelListeners">_applyModelListeners</a></li>
            
                <li data-name="BaseView#_breezeCallback"><a href="BaseView.html#_breezeCallback">_breezeCallback</a></li>
            
                <li data-name="BaseView#_contextModelListen"><a href="BaseView.html#_contextModelListen">_contextModelListen</a></li>
            
                <li data-name="BaseView#_createViewModel"><a href="BaseView.html#_createViewModel">_createViewModel</a></li>
            
                <li data-name="BaseView#_createViewModelHelper"><a href="BaseView.html#_createViewModelHelper">_createViewModelHelper</a></li>
            
                <li data-name="BaseView#_getAddress"><a href="BaseView.html#_getAddress">_getAddress</a></li>
            
                <li data-name="BaseView#_updateContextModel"><a href="BaseView.html#_updateContextModel">_updateContextModel</a></li>
            
                <li data-name="BaseView#afterRender"><a href="BaseView.html#afterRender">afterRender</a></li>
            
                <li data-name="BaseView#beforeRender"><a href="BaseView.html#beforeRender">beforeRender</a></li>
            
                <li data-name="BaseView#createViewModel"><a href="BaseView.html#createViewModel">createViewModel</a></li>
            
                <li data-name="BaseView#dispose"><a href="BaseView.html#dispose">dispose</a></li>
            
                <li data-name="BaseView#fetchTemplate"><a href="BaseView.html#fetchTemplate">fetchTemplate</a></li>
            
                <li data-name="BaseView#getViewModel"><a href="BaseView.html#getViewModel">getViewModel</a></li>
            
                <li data-name="BaseView#renderBindings"><a href="BaseView.html#renderBindings">renderBindings</a></li>
            
                <li data-name="BaseView#renderComplete"><a href="BaseView.html#renderComplete">renderComplete</a></li>
            
                <li data-name="BaseView#resetBindings"><a href="BaseView.html#resetBindings">resetBindings</a></li>
            
                <li data-name="BaseView#resetElement"><a href="BaseView.html#resetElement">resetElement</a></li>
            
                <li data-name="BaseView#setModel"><a href="BaseView.html#setModel">setModel</a></li>
            
                <li data-name="BaseView#setViewModel"><a href="BaseView.html#setViewModel">setViewModel</a></li>
            
                <li data-name="BaseView#start"><a href="BaseView.html#start">start</a></li>
            
                <li data-name="BaseView#subscribe"><a href="BaseView.html#subscribe">subscribe</a></li>
            
                <li data-name="BaseView#trackValidation"><a href="BaseView.html#trackValidation">trackValidation</a></li>
            
                <li data-name="BaseView#updateViewModel"><a href="BaseView.html#updateViewModel">updateViewModel</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="Controller">
            <span class="title">
                <a href="Controller.html">Controller</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Controller#_prepActions"><a href="Controller.html#_prepActions">_prepActions</a></li>
            
                <li data-name="Controller#buildMenuActions"><a href="Controller.html#buildMenuActions">buildMenuActions</a></li>
            
                <li data-name="Controller#dispose"><a href="Controller.html#dispose">dispose</a></li>
            
                <li data-name="Controller#getView"><a href="Controller.html#getView">getView</a></li>
            
                <li data-name="Controller#renderLayout"><a href="Controller.html#renderLayout">renderLayout</a></li>
            
                <li data-name="Controller#setView"><a href="Controller.html#setView">setView</a></li>
            
                <li data-name="Controller#start"><a href="Controller.html#start">start</a></li>
            
                <li data-name="Controller#startAction"><a href="Controller.html#startAction">startAction</a></li>
            
                <li data-name="Controller#verifyAction"><a href="Controller.html#verifyAction">verifyAction</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="DataService">
            <span class="title">
                <a href="DataService.html">DataService</a>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="DataService~queryFailed"><a href="DataService.html#queryFailed">queryFailed</a></li>
            
                <li data-name="DataService~querySucceeded"><a href="DataService.html#querySucceeded">querySucceeded</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="DataService#_filterByLocation"><a href="DataService.html#_filterByLocation">_filterByLocation</a></li>
            
                <li data-name="DataService#applyPredicate"><a href="DataService.html#applyPredicate">applyPredicate</a></li>
            
                <li data-name="DataService#get"><a href="DataService.html#get">get</a></li>
            
                <li data-name="DataService#getChildCollection"><a href="DataService.html#getChildCollection">getChildCollection</a></li>
            
                <li data-name="DataService#getCollection"><a href="DataService.html#getCollection">getCollection</a></li>
            
                <li data-name="DataService#getEntityInfo"><a href="DataService.html#getEntityInfo">getEntityInfo</a></li>
            
                <li data-name="DataService#getEntityName"><a href="DataService.html#getEntityName">getEntityName</a></li>
            
                <li data-name="DataService#getEntityTypeByResource"><a href="DataService.html#getEntityTypeByResource">getEntityTypeByResource</a></li>
            
                <li data-name="DataService#getErrorMessage"><a href="DataService.html#getErrorMessage">getErrorMessage</a></li>
            
                <li data-name="DataService#getLocationCollection"><a href="DataService.html#getLocationCollection">getLocationCollection</a></li>
            
                <li data-name="DataService#getMessageFromEntityError"><a href="DataService.html#getMessageFromEntityError">getMessageFromEntityError</a></li>
            
                <li data-name="DataService#getValidationMessages"><a href="DataService.html#getValidationMessages">getValidationMessages</a></li>
            
                <li data-name="DataService#subscribe"><a href="DataService.html#subscribe">subscribe</a></li>
            
                <li data-name="DataService#validatePredicate"><a href="DataService.html#validatePredicate">validatePredicate</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="Grid">
            <span class="title">
                <a href="Grid.html">Grid</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Grid#_afterRender"><a href="Grid.html#_afterRender">_afterRender</a></li>
            
                <li data-name="Grid#_applyFilter"><a href="Grid.html#_applyFilter">_applyFilter</a></li>
            
                <li data-name="Grid#_assemblePredicate"><a href="Grid.html#_assemblePredicate">_assemblePredicate</a></li>
            
                <li data-name="Grid#_buildColumns"><a href="Grid.html#_buildColumns">_buildColumns</a></li>
            
                <li data-name="Grid#_buildLayout"><a href="Grid.html#_buildLayout">_buildLayout</a></li>
            
                <li data-name="Grid#_buildViewModel"><a href="Grid.html#_buildViewModel">_buildViewModel</a></li>
            
                <li data-name="Grid#_fetch"><a href="Grid.html#_fetch">_fetch</a></li>
            
                <li data-name="Grid#_filter"><a href="Grid.html#_filter">_filter</a></li>
            
                <li data-name="Grid#_getDataType"><a href="Grid.html#_getDataType">_getDataType</a></li>
            
                <li data-name="Grid#_getEntityInfo"><a href="Grid.html#_getEntityInfo">_getEntityInfo</a></li>
            
                <li data-name="Grid#_loadEntityData"><a href="Grid.html#_loadEntityData">_loadEntityData</a></li>
            
                <li data-name="Grid#_predicateFilter"><a href="Grid.html#_predicateFilter">_predicateFilter</a></li>
            
                <li data-name="Grid#_sortEngine"><a href="Grid.html#_sortEngine">_sortEngine</a></li>
            
                <li data-name="Grid#_sortHandler"><a href="Grid.html#_sortHandler">_sortHandler</a></li>
            
                <li data-name="Grid#_updateCollections"><a href="Grid.html#_updateCollections">_updateCollections</a></li>
            
                <li data-name="Grid#addColumns"><a href="Grid.html#addColumns">addColumns</a></li>
            
                <li data-name="Grid#dispose"><a href="Grid.html#dispose">dispose</a></li>
            
                <li data-name="Grid#filter"><a href="Grid.html#filter">filter</a></li>
            
                <li data-name="Grid#getSelected"><a href="Grid.html#getSelected">getSelected</a></li>
            
                <li data-name="Grid#getView"><a href="Grid.html#getView">getView</a></li>
            
                <li data-name="Grid#getViewModel"><a href="Grid.html#getViewModel">getViewModel</a></li>
            
                <li data-name="Grid#removeColumns"><a href="Grid.html#removeColumns">removeColumns</a></li>
            
                <li data-name="Grid#removeFilter"><a href="Grid.html#removeFilter">removeFilter</a></li>
            
                <li data-name="Grid#render"><a href="Grid.html#render">render</a></li>
            
                <li data-name="Grid#setSelected"><a href="Grid.html#setSelected">setSelected</a></li>
            
                <li data-name="Grid#updateViewModels"><a href="Grid.html#updateViewModels">updateViewModels</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            <span class="subtitle">Events</span>
            
                <li data-name="Grid#event:hasData"><a href="Grid.html#event:hasData">hasData</a></li>
            
            </ul>
        </li>
    
        <li class="item" data-name="Info">
            <span class="title">
                <a href="Info.html">Info</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Info#applyClaimsAccess"><a href="Info.html#applyClaimsAccess">applyClaimsAccess</a></li>
            
                <li data-name="Info#cleanViews"><a href="Info.html#cleanViews">cleanViews</a></li>
            
                <li data-name="Info#getActive"><a href="Info.html#getActive">getActive</a></li>
            
                <li data-name="Info#getController"><a href="Info.html#getController">getController</a></li>
            
                <li data-name="Info#getModule"><a href="Info.html#getModule">getModule</a></li>
            
                <li data-name="Info#recycle"><a href="Info.html#recycle">recycle</a></li>
            
                <li data-name="Info#renderModule"><a href="Info.html#renderModule">renderModule</a></li>
            
                <li data-name="Info#setActive"><a href="Info.html#setActive">setActive</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="KnockoutBindings">
            <span class="title">
                <a href="KnockoutBindings.html">KnockoutBindings</a>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="KnockoutBindings._this.bootstrapGrid"><a href="KnockoutBindings.html#_this.bootstrapGrid">_this.bootstrapGrid</a></li>
            
                <li data-name="KnockoutBindings._this.locationBreadcrumbs"><a href="KnockoutBindings.html#_this.locationBreadcrumbs">_this.locationBreadcrumbs</a></li>
            
                <li data-name="KnockoutBindings._this.subNav"><a href="KnockoutBindings.html#_this.subNav">_this.subNav</a></li>
            
                <li data-name="KnockoutBindings._this.urlArgs"><a href="KnockoutBindings.html#_this.urlArgs">_this.urlArgs</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="Location">
            <span class="title">
                <a href="Location.html">Location</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Location#_buildCrumbs"><a href="Location.html#_buildCrumbs">_buildCrumbs</a></li>
            
                <li data-name="Location#setActive"><a href="Location.html#setActive">setActive</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            <span class="subtitle">Events</span>
            
                <li data-name="Location#location:change"><a href="Location.html#event:location:change">location:change</a></li>
            
            </ul>
        </li>
    
        <li class="item" data-name="Modal">
            <span class="title">
                <a href="Modal.html">Modal</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Modal#_buttonClick"><a href="Modal.html#_buttonClick">_buttonClick</a></li>
            
                <li data-name="Modal#_modalOnClose"><a href="Modal.html#_modalOnClose">_modalOnClose</a></li>
            
                <li data-name="Modal#close"><a href="Modal.html#close">close</a></li>
            
                <li data-name="Modal#renderComplete"><a href="Modal.html#renderComplete">renderComplete</a></li>
            
                <li data-name="Modal#setContentView"><a href="Modal.html#setContentView">setContentView</a></li>
            
                <li data-name="Modal#show"><a href="Modal.html#show">show</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="QueueService">
            <span class="title">
                <a href="QueueService.html">QueueService</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="QueueService#_error"><a href="QueueService.html#_error">_error</a></li>
            
                <li data-name="QueueService#_success"><a href="QueueService.html#_success">_success</a></li>
            
                <li data-name="QueueService#callApiMethod"><a href="QueueService.html#callApiMethod">callApiMethod</a></li>
            
                <li data-name="QueueService#CallNextForService"><a href="QueueService.html#CallNextForService">CallNextForService</a></li>
            
                <li data-name="QueueService#CallTicket"><a href="QueueService.html#CallTicket">CallTicket</a></li>
            
                <li data-name="QueueService#CancelTicket"><a href="QueueService.html#CancelTicket">CancelTicket</a></li>
            
                <li data-name="QueueService#CompleteTicket"><a href="QueueService.html#CompleteTicket">CompleteTicket</a></li>
            
                <li data-name="QueueService#GetCurrentInService"><a href="QueueService.html#GetCurrentInService">GetCurrentInService</a></li>
            
                <li data-name="QueueService#GetWaitList"><a href="QueueService.html#GetWaitList">GetWaitList</a></li>
            
                <li data-name="QueueService#HoldTicket"><a href="QueueService.html#HoldTicket">HoldTicket</a></li>
            
                <li data-name="QueueService#MoveTicketToWait"><a href="QueueService.html#MoveTicketToWait">MoveTicketToWait</a></li>
            
                <li data-name="QueueService#PauseTicket"><a href="QueueService.html#PauseTicket">PauseTicket</a></li>
            
                <li data-name="QueueService#UpdateService"><a href="QueueService.html#UpdateService">UpdateService</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="Router">
            <span class="title">
                <a href="Router.html">Router</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Router#_getActiveLayout"><a href="Router.html#_getActiveLayout">_getActiveLayout</a></li>
            
                <li data-name="Router#_getArgs"><a href="Router.html#_getArgs">_getArgs</a></li>
            
                <li data-name="Router#_setLayout"><a href="Router.html#_setLayout">_setLayout</a></li>
            
                <li data-name="Router#default"><a href="Router.html#default">default</a></li>
            
                <li data-name="Router#go"><a href="Router.html#go">go</a></li>
            
                <li data-name="Router#login"><a href="Router.html#login">login</a></li>
            
                <li data-name="Router#show404"><a href="Router.html#show404">show404</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="User">
            <span class="title">
                <a href="User.html">User</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="User#IsTopLevelLocationDeleted"><a href="User.html#IsTopLevelLocationDeleted">IsTopLevelLocationDeleted</a></li>
            
                <li data-name="User#login"><a href="User.html#login">login</a></li>
            
                <li data-name="User#loginSuccess"><a href="User.html#loginSuccess">loginSuccess</a></li>
            
                <li data-name="User#logout"><a href="User.html#logout">logout</a></li>
            
                <li data-name="User#verify"><a href="User.html#verify">verify</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            <span class="subtitle">Events</span>
            
                <li data-name="User#user:login"><a href="User.html#event:user:login">user:login</a></li>
            
                <li data-name="User#user:logout"><a href="User.html#event:user:logout">user:logout</a></li>
            
            </ul>
        </li>
    
        <li class="item" data-name="Utils">
            <span class="title">
                <a href="Utils.html">Utils</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Utils#formatDate"><a href="Utils.html#formatDate">formatDate</a></li>
            
                <li data-name="Utils#formatDateTime"><a href="Utils.html#formatDateTime">formatDateTime</a></li>
            
                <li data-name="Utils#formatTime"><a href="Utils.html#formatTime">formatTime</a></li>
            
                <li data-name="Utils#getForm"><a href="Utils.html#getForm">getForm</a></li>
            
                <li data-name="Utils#hoursMinutes"><a href="Utils.html#hoursMinutes">hoursMinutes</a></li>
            
                <li data-name="Utils#trackedBreezeCollection"><a href="Utils.html#trackedBreezeCollection">trackedBreezeCollection</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="dataservice.js.html">Source: lib/dataservice.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/* global define, console, app, EventSource, saveFailed, window, QueryEngine, Backbone, $ */
/**
 * Primary breeze dataservice.  Accessible via app.api
 * @module DataService
 */
define([
    'underscore',
    'breeze',
    'backbone',
    'metadata'
], function(_, breeze, backbone) {
    "use strict";

    /**
     * @constructor
     * @alias DataService
     * @property {Object} breeze - Reference to breeze library
     * @property {String} root - URL endpoint for the WebApi
     * @property {String} serviceName - URL endpoint for the breeze service in WebApi
     * @property {Object} manager - Breeze entity manager for this dataservice
     * @property {Object} Predicate - reference to breeze Predicate factory
     * @property {Object} FilterQueryOp - reference to breeze FilterQueryOp
     * @property {Object} collections - Object storing query engines for breeze entities
     * @property {Object} [collections.Locations] - Example format for an collection of Location entities
     * @property {Object} locationCollections -  Object storing query engines (filtered by active location)
     * for breeze entities
     */
    var DataService = function() {

        // Breeze / API Configuration 
        // --------------------------

        // Configure Breeze for Backbone (config'd for Web API by default)
        // This sets up breeze to return backbone style models
        breeze.config.initializeAdapterInstances({
            modelLibrary: "backbone"
        });

        // this.root used for ajax setup in non-breeze api calls
        this.root = (app &amp;&amp; app.api_root) ? app.api_root : '/Ess.WebAPI';

        // Service name is route to the Web API controller (for breeze)
        var serviceName = this.serviceName = this.root + '/breeze/Breeze';


        // Setup Entity Manager
        // --------------------

        // Define the breeze dataservice
        var dataService = new breeze.DataService({
            serviceName: serviceName,
            // Comment out this line if you want to force metadata load
            hasServerMetadata: false // don't ask the server for metadata
        });

        // create and initialize the metadatastore from local metadata
        var metadataStore = new breeze.MetadataStore();
        // Comment out this line if you want to force metadata retrieval
        metadataStore.importMetadata(window.metadata);

        var manager = this.manager = new breeze.EntityManager({
            dataService: dataService,
            metadataStore: metadataStore
        });

        // Dataservice Properties
        // ----------------------

        // Setup references to Breeze and Breeze methods 
        this.breeze = breeze;
        this.Predicate = breeze.Predicate;
        this.FilterQueryOp = breeze.FilterQueryOp;


        // Dataservice Query Engine and Local Cache
        // ----------------------------------------

        // Master query engine collection object, each entity type will derive 
        // child collections from this. Backbone.Collection will not allow for conflicting Ids,
        // thus this.entities will hold a reference to a collection for each entity type
        // For example: this.entities.Activities = (Query Engine Collection)
        // https://github.com/bevry/query-engine
        this.collections = {};
        this.locationCollections = {};

        // Setup subscription to manage collections on entity change
        // Currently primary purpose is to manage deletions, detachments
        manager.entityChanged.subscribe(function(changeArgs) {
            // This code will be executed any time any entity within the entityManager is added, modified, deleted or detached for any reason. 
            if (changeArgs.entity.entityAspect.entityState.isDeleted() || changeArgs.entity.entityAspect.entityState.isDetached()) {
                // Rerun our query on applicable collection to update any filters (including default filter for detached/deleted)
                app.api.getCollection(app.api.getEntityName(changeArgs.entity)).query();
                // Mark the pending deletion.  If reject changes are called we will need this as a reference to re-instate this entity
                // in it's collection.
                changeArgs.entity._disposed = true;
            } else if (changeArgs.entity._disposed) {
                app.api.getCollection(app.api.getEntityName(changeArgs.entity)).add(changeArgs.entity);
                changeArgs.entity._disposed = false;
            }
        });

        /**
         * Returns a query engine for specified resource which tracks entities of resource type
         * extant in the entityManager
         * @param {String} shortName - shortname for resource to be retrieved (ie. 'Location')
         * @returns {Collection} Live QueryEngine populated with specified resource
         */
        this.getCollection = function(shortName) {
            if (!this.collections[shortName]) {
                this.collections[shortName] = new QueryEngine.createLiveCollection()
                    .setFilter('suppressDeletedDetached', function(model) {
                        if (model.entityAspect &amp;&amp; model.entityAspect.entityState) {
                            var state = model.entityAspect.entityState;
                            if (state.isDeleted() || state.isDetached()) return false;
                            else return true;
                        }
                        return false;
                    });
            }
            return this.collections[shortName];
        };

        /**
         * Helper(shortcut) method for intializing a child collection from this.collections
         * @param {String} shortName - shortname for resource to be retrieved (ie. 'Location')
         * @returns {Collection} new Live Child QueryEngine populated with specified resource
         */
        this.getChildCollection = function(shortName) {
            return this.getCollection(shortName).createLiveChildCollection();
        };

        /**
         * Get a collection based on the currently active collection.  Builds a queryEngine child from this.collections
         * with a filter for locationId applied.
         * @param {String} shortname - Name of the entity type to get collection for
         * @returns {Collection} new Live Child QueryEngine populated with specified resource
         */
        this.getLocationCollection = function(shortName) {
            if (!this.locationCollections[shortName]) {
                var queryEngine = this.locationCollections[shortName] = this.getCollection(shortName).createLiveChildCollection();
                queryEngine.setFilter('filterByLocation', this._filterByLocation);
                // Even if there is no active location, returning null here will mean that each record will fail (so no locaiton, no data)
                queryEngine.setSearchString(shortName + ':' + app.location.get('active')).query();

                // Setup subscription to location change
                queryEngine.listenTo(Backbone.EventBroker, "location:change", function(event) {
                    this.setSearchString(shortName + ':' + event.LocationId).query();
                });

            }
            return this.locationCollections[shortName];
        };

        /**
         * Filter function to apply to each locationCollection.  Allows locationCollection to return only those
         * models applicable to the collection.
         * @private
         * @param {Backbone.Model} model - Model to be checked
         * @param {String} searchString - pill (key:value) to compare against
         */
        this._filterByLocation = function(model, searchString) {
            if (searchString) {
                var args = searchString.split(':')[1];
                var shortName = args[0];
                // TODO update this method to reference shortName above (ex: Location)
                // to determine what property to use
                var thisId = (model.get('LocationId')) ? model.get('LocationId') : model.get('ParentId');
                return thisId == parseInt(args);
            } else {
                return true;
            }
        };

        // Import data from local storage
        // TODO: Define and setup conditions in which this is performed
        if (true === false) {
            var importData = window.localStorage.getItem('ESS_Entities');
            if (importData) this.manager.importEntities(importData);
        }

        // By default, stash data for offline or for easy access on refresh
        // TODO: Not currently being utilized
        window.onbeforeunload = function(event) {
            var exportData = app.api.manager.exportEntities();
            window.localStorage.setItem('ESS_Entities', exportData);
            //return 'Please dont leave!';
        };

        // Dataservice API
        // ---------------

        /**
         *  Helper function for returning entity info for a given model
         * @param {Backbone.Model} model - Breeze entity to be examined
         * @returns {Object} entityInfo - Object with information applicable to the referenced entity
         * @returns {Object} entityInfo.entityManager - reference to entities entity manager
         * @returns {String} entityInfo.shortName - entitie's shortName
         * @returns {Object} entityInfo.entityType - entitie's entityType
         */
        this.getEntityInfo = function(model) {
            var entityInfo = {};
            if (model.entityAspect) {
                entityInfo.entityManager = model.entityAspect.entityManager;
                entityInfo.shortName = model.entityAspect.entityGroup.entityType.shortName;
                entityInfo.entityType = entityInfo.entityManager.metadataStore.getEntityType(entityInfo.shortName);
            }
            return entityInfo;
        };

        /**
         * Default method for retrieving data.
         * @param {Object} query - instanceof breeze.entityQuery
         * @param {Object} [context=args] - context to run the success function in
         * @param {Object} [args] - Arguments for reference within querySucceeded and callback (if applicable)'
         * @param {Boolean} [args.refresh] - if true, will refresh data regardless of results in local cache
         * @param {Function} [args.callback] - callback to fire on query success
         * @param {Function} [args.then] - callback to fire on query success (directly after callback)
         * @param {Object} [args.gritter] - Data to reference to create a gritter message
         * @param {Object} [args.gritter.success] - Gritter title/text object to pass to ritter (for success messaging)
         * @param {Object} [args.gritter.fail] - Gritter title/text object to pass to ritter (for failure messaging)
         */
        this.get = function get(query, args, context) {
            var local, data, success, failure;
            if (!args) args = {};
            if (context) {
                success = _.bind(querySucceeded, context);
                failure = _.bind(queryFailed, context);
            } else {
                success = _.bind(querySucceeded, args);
                failure = _.bind(queryFailed, args);
            }
            // TODO double think about this pattern,
            // Is it more optimal to request all the time refresh, assuming local, or vice versa
            try {
                if (args.refresh) {
                    query.execute().then(success).fail(failure);
                } else {
                    local = app.api.manager.executeQueryLocally(query);
                    if (local.length === 0) query.execute().then(success).fail(failure);
                    else success({
                        results: local
                    });
                }
            } catch (err) {
                // if the above returned an error, it is likely due to missing metadata 
                query.execute().then(success).fail(failure);
            }
        };

        /*
         * Save Changes
         * @param {Array.&lt;Backbone.Model>} [entities] - Entities to save changes on.  If absent, save all changes.
         * @param {Function} [args.callback] - callback to fire on save success
         * @param {Function} [args.then] - callback to fire on save success (directly after callback)
         * @param {Object} [args.gritter] - Data to reference to create a gritter message
         * @param {Object} [args.gritter.success] - Gritter title/text object to pass to ritter (for success messaging)
         * @param {Object} [args.gritter.fail] - Gritter title/text object to pass to ritter (for failure messaging)
         */
        this.saveChanges = function saveChanges(entities, args) {
            if (!args) args = {};
            if (manager.hasChanges()) {
                var success = _.bind(querySucceeded, args);
                var failure = _.bind(queryFailed, args);
                return manager.saveChanges(entities)
                    .then(success)
                    .fail(failure);
            }
        };

        // Default Success/Failure Handling
        // --------------------------------

        /**
         * Default failure function to handle query failure
         * @private
         */
        var queryFailed = this.queryFailed = function(response) {
            if (this.gritter &amp;&amp; this.gritter.fail) $.gritter.add(this.gritter.fail);
            if (this.fail) this.fail(response);
            console.log('Ouch!');
            console.log(response);
        };

        /**
         * Default success function to handle query success
         * @private
         */
        var querySucceeded = this.querySucceeded = function(data) {
            var entityInfo, results = (data.results) ? data.results : data.entities;
            // Add entities to query engines for tracking across the app
            if (results) {
                for (var i = 0; i &lt; results.length; i++) {
                    entityInfo = app.api.getEntityInfo(results[i]);
                    if (entityInfo) {
                        app.api.getCollection(entityInfo.shortName).add(results[i]);
                    }
                }
            }
            if (this.callback) return this.callback(data, this);
            if (this.then) this.then(data, this);
            if (this.gritter &amp;&amp; this.gritter.success) $.gritter.add(this.gritter.success);
            return data;
        };

        // Dataservice subscription Handling
        // ---------------------------------

        /**
         * Currently only being used by getActivities, which is deprecated
         * TODO: Update this to act as one global listener
         * @private
         */
        this.subscribe = function(args) {

            var source = new EventSource(args.subscribe.resource);
            source.addEventListener('message', function(e) {
                var json = JSON.parse(e.data);
                if (args.subscribe &amp;&amp; args.subscribe.callback) args.subscribe.callback(json, args);
            }, false);

            source.addEventListener('open', function(e) {
                console.log("open!");
            }, false);

            source.addEventListener('error', function(e) {
                if (e.readyState == source.CLOSED) {
                    console.log("error!");
                }
            }, false);

            if (args.subscribe &amp;&amp; args.subscribe.onOpen) args.subscribe.onOpen(args);

        };

        // Breeze Entity Validation Methods
        // --------------------------------

        // getErrorMessage, getValidationMessages, getMessageFromEntityError, getEntityName were taken from http://www.breezejs.com/documentation/saveerrorextensionsjs and updated.

        /**
         *  Function to get error message during failed event in breeze save changes method.
         * @param {Object} error - breeze error object
         * @returns {String} error validation messages (separated by &lt;br/>)
         */
        this.getErrorMessage = function(error) {
            var msg = error.message;
            var entityErrors = error.entityErrors;
            if (entityErrors &amp;&amp; entityErrors.length) {
                return this.getValidationMessages(entityErrors);
            }
            return msg;
        };

        /**
         * Helper function for getErrorMessage
         * @private
         * @param {Object} entityErros - entityErrors object
         */
        this.getValidationMessages = function(entityErrors) {
            var getMessageFromEntityError = _.bind(this.getMessageFromEntityError, this);
            var isServerError = entityErrors[0].isServerError; // if the first is, they all are     
            try {
                return entityErrors.map(getMessageFromEntityError).join('; &lt;br/>');
            } catch (e) {
                /* eat it for now */
                return (isServerError ? 'server' : 'client') + ' validation error';
            }
        };

        /**
         * Helper for getValidateMessages
         * @private
         * @param {Object} entityError - entityError object
         * @returns {String} error message from
         */
        this.getMessageFromEntityError = function(entityError) {
            var name, entity = entityError.entity;
            if (entity) {
                name = this.getEntityName(entity);
            }
            name = name ? name += ' - ' : '';
            //We can probably stop the display of entity name in UI
            return name + '\'' + entityError.errorMessage + '\'';
        };

        /**
         * Helper for getMessageFromEntityError, but also useful for retrieving entity name
         * @param {Backbone.Model} entity - Breeze entity
         * @returns {String} entity shortName
         */
        this.getEntityName = function(entity) {
            var key = entity.entityAspect.getKey();
            var name = key.entityType.shortName;
            return name;
        };

        /* Specific API calls */
        // These should be deprecated/removed

        // TODO update/remove this with inclusion of global subscribe
        this.getActivities = function(args) {
            //TODO update subscribtion to occur first and get collection on promise
            var success = _.bind(this.querySucceeded, args);
            var getSubscription = _.bind(this.subscribe, args);
            //var source = (args.source) ? args.source : "Gettblappointments";
            args.subscribe = {
                resource: this.root + '/api/Activity/GetActivityUpdates',
                callback: function(data, args) {
                    // todo handle arrays?
                    console.log('subscription callback');
                    console.log(data);
                    var activity = args.ref.get(data.ActivityId);
                    if (activity) {
                        data.Activity = activity;
                        var entityInfo = app.api.getEntityInfo(activity);
                        // TODO double check if entity is already added that breeze handles this properly
                        var activityDetail = entityInfo.entityManager.createEntity("ActivityDetail", data);
                        //activity.get('ActivityDetails').push(activityDetail)
                        activity.trigger('change:ActivityDetails', [activityDetail]);
                    }
                },
                onOpen: function(args) {
                    console.log('fetching breeze');
                    return this.breeze.EntityQuery
                        .from("Activities")
                        .expand("ActivityDetails")
                        .take(args.limit)
                        .using(manager)
                        .execute()
                        .then(success)
                        .fail(queryFailed);
                }
            };
            this.subscribe(args);
        };

        // API helpers
        // -----------

        /**
         * Retrieves entityType based on resource name
         * @param {String} resourceName - resource name (shortName ie ValueItems)
         * @returns {EntityType} entityType for resource
         */
        this.getEntityTypeByResource = function(resourceName) {
            app.api.manager.metadataStore.getEntityType(app.api.manager.metadataStore.getEntityTypeNameForResourceName(resourceName))
        };

        /**
         * Tests a predicate against a collection and returns those models that have passed
         * @param {Array|Backbone.Collection} collection - Array of entities or backbone collection
         * @param {Predicate} predicate - Breeze Predicate to test against
         * @returns {Array} passed - entities that have passed the predicate
         */
        this.applyPredicate = function(collection, predicate) {
            var evaluate = (collection.models) ? collection.models : collection;
            var passed = [];
            for (var i = 0; i &lt; evaluate.length; i++) {
                if (this.validatePredicate(evaluate[i], predicate)) passed.push(evaluate[i]);
            }
            return passed;
        };

        /**
         * Tests an entity against a predicate
         * @param {Model} model - Backbone.Model to test against
         * @param {Predicate} predicate - Breeze Predicate to test against
         * @returns {Boolean}
         */
        this.validatePredicate = function(model, predicate) {
            var pass, comparator, evaluated = [];

            // If compound predicate, will have booleanQueryOp
            comparator = (predicate._booleanQueryOp &amp;&amp; predicate._booleanQueryOp.name) ? predicate._booleanQueryOp.name : predicate._filterQueryOp.name;

            // If we have child predicates to evaluate, run those first...
            if (predicate._predicates || typeof predicate._value == 'object') {

                // Check if we need to validate on related properties
                if (predicate._propertyOrExpr) {
                    var collection = model.get(predicate._propertyOrExpr);
                    if (!collection.length) collection = [collection];

                    evaluated = this.applyPredicate(collection, predicate._value);

                    switch (comparator) {
                        case 'Not':
                            return (evaluated.length == 0);
                            break;
                        case 'Or':
                        case 'Any':
                        case 'Some':
                            return (evaluated.length > 0);
                            break;
                        case 'And':
                        case 'All':
                        case 'Every':
                            return (evaluated.length == collection.length);
                            break;
                    }
                }

                var evaluate = predicate._predicates;
                // Set this up as an array for consistency
                evaluate = (evaluate.length) ? evaluate : [evaluate];

                for (var p = 0; p &lt; evaluate.length; p++) {
                    evaluated.push(this.validatePredicate(model, evaluate[p]));
                }

                switch (comparator) {
                    case 'Not':
                        pass = ($.inArray(true, evaluated) >= 0) ? false : true;
                        break;
                    case 'Or':
                    case 'Any':
                    case 'Some':
                        pass = ($.inArray(true, evaluated) >= 0) ? true : false;
                        break;
                    case 'And':
                    case 'All':
                    case 'Every':
                        pass = ($.inArray(false, evaluated) >= 0) ? false : true;
                        break;
                }
                return pass;
            }

            // If the above is skipped, we are in the context of a single predicate with no children (lowest level)
            var prop = model.get(predicate._propertyOrExpr);
            // Add a space in the instance that prop is a typeof number
            var _prop = prop + '';
            var value = predicate._value;

            // TODO implement date comparison
            if ((comparator == 'Equals') || (comparator == 'GreaterThan') || (comparator == 'LessThan')) {

            }

            switch (comparator) {
                case 'Equals':
                    return prop == value;
                    break;
                case 'NotEquals ':
                    return prop != value;
                    break;
                case 'GreaterThan':
                    return prop > value;
                    break;
                case 'LessThan':
                    return prop &lt; value;
                    break;
                case 'GreaterThanOrEqual ':
                    return prop >= value;
                    break;
                case 'LessThanOrEqual ':
                    return prop &lt;= value;
                    break;
                case 'Contains':
                    return (_prop.indexOf(value) != -1);
                    break;
                case 'EndsWith':
                    return (_prop.indexOf(value, prop.length - value.length) !== -1);
                    break;
                case 'StartsWith':
                    return (_prop.indexOf(value) == 0);
                    break;
                default:
                    console.log('Evaluation for predicate type' + comparator + 'to be implemented.');
                    return false;
                    break;
            }
        }

    };

    return DataService;

});</code></pre>
        </article>
    </section>





        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Tue May 13 2014 13:18:45 GMT-0400 (Eastern Daylight Time)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>